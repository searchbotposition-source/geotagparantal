<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>ParentAlloc — Localización Avanzada</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-11DMCLMJWC"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-11DMCLMJWC');
  </script>
  
  <style>
    :root{
      --bg-img: url("https://images.unsplash.com/photo-1451187580459-43490279c0fa?q=80&w=2000&auto=format&fit=crop");
      --bg-int-img: url("https://images.unsplash.com/photo-1504384308090-c894fdcc538d?q=80&w=1600&auto=format&fit=crop");
      --bg:#060b17; --bg2:#0a1426; --glass:rgba(255,255,255,.06);
      --card:rgba(255,255,255,.04); --border:rgba(255,255,255,.12);
      --txt:#eaf3ff; --muted:#a9bbd8; --ok:#86efac; --err:#feb2b2;
      --accent:#67b0ff; --accent2:#8cd1ff; --brand:#93c5fd; --shadow:0 12px 50px rgba(0,0,0,.45);
      --radius:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;color:var(--txt);background:linear-gradient(180deg,#e8f3fc,#fafdff);color:#16334e;}
    body::before{content:"";position:fixed;inset:0;z-index:-2;pointer-events:none;background-image:var(--bg-img);background-size:cover;background-position:center;filter:saturate(.9)brightness(.55)}
    body::after{content:"";position:fixed;inset:0;z-index:-1;pointer-events:none;background:radial-gradient(1400px 800px at 80% -10%, rgba(25,45,85,.65) 0%, transparent 70%),linear-gradient(180deg, rgba(6,11,23,.85), rgba(10,20,38,.85));mask-image: radial-gradient(80% 80% at 50% 20%, rgba(0,0,0,.95), transparent 120%)}
    @media (min-width:1024px){ body::before{background-attachment:fixed} }

    .header{position:sticky;top:0;z-index:20;display:flex;align-items:center;justify-content:space-between;padding:12px 18px;border-bottom:1px solid var(--border);background:linear-gradient(180deg, rgba(12,20,40,.75), rgba(12,20,40,.55));backdrop-filter: blur(10px)}
    .brand{display:flex;align-items:center;gap:10px;font-weight:800;letter-spacing:.02em}
    .logo{width:32px;height:32px;border-radius:9px;position:relative;overflow:hidden;background:conic-gradient(from 140deg, #6aa9ff, #b0e1ff, #6aa9ff);box-shadow:0 6px 22px rgba(103,176,255,.35)}
    .logo::after{content:"";position:absolute;inset:2px;border-radius:7px;background:#0a1426}
    .pill{font-size:11px;padding:4px 9px;border-radius:999px;background:linear-gradient(90deg, rgba(147,197,253,.16), rgba(103,176,255,.16));border:1px solid rgba(147,197,253,.35);color:#cfe5ff}
    .footer{margin-top:auto;padding:16px 18px;font-size:12px;color:var(--muted);border-top:1px solid var(--border);background:linear-gradient(180deg, rgba(12,20,40,.25), rgba(12,20,40,.35));backdrop-filter: blur(6px)}

    .container{width:min(1200px,100%);margin:18px auto;padding:0 16px;position:relative;z-index:1}
    .shell{position:relative;overflow:hidden;border:1px solid var(--border);border-radius:var(--radius);background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.02));box-shadow:0 2px 16px #2281d012,inset 0 1px 0 #fff3;border-radius:18px !important;border-color:#39bdfc22 !important;color:#183244}
    .shell::before{content:"";position:absolute;inset:0;z-index:-1;pointer-events:none;background-image:var(--bg-int-img);background-size:cover;background-position:center;filter:blur(18px) saturate(.8) brightness(.55);opacity:.45}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:12px 14px;border-bottom:1px solid var(--border);background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));backdrop-filter: blur(4px);background:#f4fafd !important;color:#5a6d82}
    .topbar .title{font-weight:800;font-size:15px;letter-spacing:.03em}
    .topbar .sub{font-size:12px;color:var(--muted)}
    .grid{display:grid;grid-template-columns:420px 1fr;gap:16px;padding:14px}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}

    .panel{border:1px solid var(--border);border-radius:12px;background:rgba(8,16,32,.55);backdrop-filter: blur(10px);padding:14px;display:flex;flex-direction:column;gap:12px;box-shadow:inset 0 1px 0 rgba(255,255,255,.04)}
    h2{margin:0;font-size:16px}
    label{font-size:13px;color:#d8e6ff}
    .row{display:flex;gap:8px;align-items:center}
    select,input,button{-webkit-appearance:none;appearance:none;outline:none;border-radius:11px;border:1px solid rgba(255,255,255,.12);background:linear-gradient(180deg,#f4fafd,#f4fafd);color:#193e59;padding:12px 12px;font-size:15px;transition:border-color .15s, transform .06s ease}
    select:focus,input:focus{border-color:var(--accent)}
    select{min-width:240px} input{flex:1}
    .hint{font-size:12px;color:var(--muted)}
    .status{min-height:20px;font-size:13px}.status.ok{color:#16c362} .status.err{color:var(--err)}
    .btn{cursor:pointer;font-weight:800;border:0}
    .btnPrimary{background:#009ee3!important;color:#fff!important;border:2px solid rgba(255,255,255,0.3)!important;box-shadow:0 8px 24px rgba(0,158,227,0.4)!important;border-radius:12px!important;font-size:17px!important;padding:14px 24px!important;}
    .btnPrimary:active{transform:translateY(1px)}
    .btnPrimary:hover:not(:disabled){background:#0084c2!important;border-color:rgba(255,255,255,0.5)!important;}
    .btnPrimary:disabled{background:#009ee3!important;color:#fff!important;opacity:0.7!important;cursor:not-allowed!important;}
    .btnGhost{background:#deeff9;color:#1b3d4f}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .progress{height:10px;border-radius:999px;background:rgba(255,255,255,.10);overflow:hidden;display:none}
    .progress>i{display:block;height:100%;width:0;background:linear-gradient(90deg, var(--accent), var(--accent2))}

    .mapWrap{position:relative;border:1px solid var(--border);border-radius:12px;overflow:hidden;background:rgba(5,12,24,.6);backdrop-filter: blur(6px);box-shadow: inset 0 1px 0 rgba(255,255,255,.03)}
    #map{width:100%;height:620px}
    @media (max-width:980px){#map{height:480px}}
    /* Terminal Hacker integrado en el panel */
    .terminal-hud {
      width: 100%;
      min-height: 200px;
      background: linear-gradient(135deg, #0a0a0a, #1a1a1a);
      border: 1px solid #333;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      overflow: hidden;
      box-shadow: 0 0 25px rgba(0, 255, 0, 0.4), inset 0 1px 0 rgba(255,255,255,0.1);
      display: flex;
      flex-direction: column;
    }
    .terminal-header {
      background: linear-gradient(90deg, #2a2a2a, #1a1a1a);
      padding: 8px 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid #333;
    }
    .terminal-buttons {
      display: flex;
      gap: 6px;
    }
    .btn-close, .btn-minimize, .btn-maximize {
      width: 12px;
      height: 12px;
      border-radius: 50%;
    }
    .btn-close { background: #ff5f56; }
    .btn-minimize { background: #ffbd2e; }
    .btn-maximize { background: #27ca3f; }
    .terminal-title {
      color: #00ff00;
      font-size: 12px;
      font-weight: bold;
    }
    .terminal-body {
      padding: 15px;
      background: #000;
      min-height: 160px;
      max-height: 160px;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: #00ff41 #1a1a1a;
    }
    .terminal-body::-webkit-scrollbar {
      width: 6px;
    }
    .terminal-body::-webkit-scrollbar-track {
      background: #1a1a1a;
    }
        .terminal-body::-webkit-scrollbar-thumb {
          background: #00ff41;
          border-radius: 3px;
        }
        @keyframes blink {
          0%, 50% { opacity: 1; }
          51%, 100% { opacity: 0; }
        }
    .terminal-line {
      color: #00ff00;
      margin-bottom: 8px;
      font-size: 12px;
    }
    .terminal-cursor {
      animation: blink 1s infinite;
    }
    @keyframes blink {
      0%, 50% { opacity: 1; }
      51%, 100% { opacity: 0; }
    }
    .hudStep {
      color: #00ff00;
      font-family: 'Courier New', monospace;
      margin: 4px 0;
      font-size: 12px;
    }
    .hudSub {
      color: #00ffff;
      font-family: 'Courier New', monospace;
      font-size: 11px;
      margin: 2px 0;
    }
    .hudCarrier {
      color: #ffff00;
      font-family: 'Courier New', monospace;
      font-size: 11px;
      margin: 2px 0;
    }
    .spinner{width:16px;height:16px;border:2px solid rgba(255,255,255,.25);border-top-color:#7fb7ff;border-radius:50%;animation:spin 1s linear infinite;display:inline-block;margin-right:8px;vertical-align:-3px}
    @keyframes spin{to{transform:rotate(360deg)}}
    @keyframes radar{0%{transform:translate(-50%,-50%) scale(0.5);opacity:1}100%{transform:translate(-50%,-50%) scale(1.5);opacity:0}}
    @keyframes pulse-button{0%,100%{transform:scale(1);box-shadow:0 4px 15px rgba(0,184,148,0.4)}50%{transform:scale(1.02);box-shadow:0 6px 25px rgba(0,184,148,0.7)}}

    .modalBack{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.95);z-index:99999;overflow-y:auto;padding:20px 0;backdrop-filter:blur(10px);}
    .modal{width:min(720px,94%);border:2px solid #4f9fff;border-radius:16px;background:linear-gradient(180deg, #1a2332, #0f1419);box-shadow: 0 20px 60px rgba(0,0,0,0.8);padding:24px;max-height:85vh;overflow-y:auto;position:relative;margin:auto;}
    .modal h3{margin:0 0 8px 0}
    .modal .actions{display:flex;gap:10px;justify-content:flex-end;margin-top:12px;flex-wrap:wrap}
    .btnDownload{background:linear-gradient(90deg,#21d682,#06bad7)!important;color:#003013;border:0;padding:12px 18px;border-radius:13px;font-size:17px;font-weight:800;cursor:pointer}
    body{background:#0a1422!important;color:#eaf6ff;}
    .shell,.panel,.mapWrap{background:rgba(24,37,68,0.96)!important;border-radius:17px!important;border:1px solid #223157!important;box-shadow:0 2px 18px #1170e41b; color:#eaf6ff;}
    .footer,.topbar{background:#16223a; color:#9db3c9; border:none;}
    h1,h2,h3,h4{color:#22334a}
    .btnPrimary,.btnDownload{background:#009ee3!important;color:#fff!important;border:2px solid rgba(255,255,255,0.3)!important;border-radius:12px!important;font-size:17px;font-weight:800;padding:14px 24px!important;box-shadow:0 8px 24px rgba(0,158,227,0.4)!important;}
    .btnPrimary:disabled{background:#009ee3!important;color:#fff!important;opacity:0.7!important;cursor:not-allowed!important;}
    .btn,.btnGhost{background:#1c2a3c!important;color:#abffea!important;}
    input,select{background:#142940;color:#eaf6ff; font-weight:500}
    .brand{color:#32cfae!important;}
    .status,.muted,.hint{color:#c8e1fb!important}
    .badge{background:#163544!important;color:#b2fbe9!important;}
  </style>

  <!-- Meta Pixel Code (ID: 2587292611639407) -->
  <script>
    !function(f,b,e,v,n,t,s)
    {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
    n.callMethod.apply(n,arguments):n.queue.push(arguments)};
    if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
    n.queue=[];t=b.createElement(e);t.async=!0;
    t.src=v;s=b.getElementsByTagName(e)[0];
    s.parentNode.insertBefore(t,s)}(window, document,'script',
    'https://connect.facebook.net/en_US/fbevents.js');
    fbq('init', '2587292611639407');
    fbq('track', 'PageView');
  </script>
  <noscript>
    <img height="1" width="1" style="display:none"
         src="https://www.facebook.com/tr?id=2587292611639407&ev=PageView&noscript=1"/>
  </noscript>
  <!-- Pixel: InitiateCheckout on click "Seguir Ubicación" -->
  <script>
    // Usamos captura a nivel documento para garantizar el disparo
    document.addEventListener('click', function(e){
      var t = e.target;
      if (!window.fbq) return;
      // Coincide si clic directo en el botón o en un hijo dentro del botón
      if ((t && t.id === 'downloadBtn') || (t.closest && t.closest('#downloadBtn'))) {
        fbq('track', 'InitiateCheckout', {
          content_name: 'Seguimiento de ubicación',
          value: 15.00,
          // Comentado: moneda de Perú
          // currency: 'PEN'
          // Argentina
          currency: 'ARS'
        });
      }
    }, true);
  </script>
  <!-- FIN Meta Pixel -->

  <!-- CONFIG del backend -->
  <script>
    /* Si el backend está en el mismo origen, deja API_BASE = "" */
    const API_BASE = "http://localhost:3000"; // <-- CAMBIA esto a tu backend
    window.gm_authFailure = () => { alert("Google Maps rechazó la clave o el dominio. Revisa billing, APIs y referrers."); };
  </script>
</head>
<body>
  <header class="header">
    <div class="brand"><div class="logo" aria-hidden="true">P</div><div>ParentAlloc</div></div>
    <div class="pill">LOCALIZA · RASTREA</div>
  </header>

  <main class="container">
    <section class="shell">
      <div class="topbar">
        <div class="title">Sistema de Geolocalización</div>
        <div class="sub">Barrido por distritos (3:00) · Heatmap + radar + triangulación · Final en <b>Ubicacion</b></div>
      </div>

      <div class="grid">
        <aside class="panel">
          <h2>Ingresa el Numero Movil</h2>
          <div class="hint">Localizamos el telefono <b>Movil</b> (Dispositivo). Donde se encuentre.</div>

          <label for="country">País (Ubicacion Actual)</label>
          <div class="row"><select id="country"></select></div>
          <div class="hint" id="ipDetect">Detectando ciudad por IP…</div>

          <label for="number">Número local</label>
          <div class="row"><input id="number" inputmode="tel" placeholder="Ej: 987654321" maxlength="16" /></div>

          <div class="row">
            <button id="simulateBtn" class="btn btnPrimary" disabled>Iniciar Localización</button>
            <button id="resetBtn" class="btn btnGhost">Reiniciar</button>
          </div>

          <div class="status" id="status">Listo.</div>
          <div class="progress" id="progress"><i id="bar"></i></div>
          <div class="hint" id="eta" style="display:none">Tiempo restante: 180 s</div>

          <div class="hint" style="margin-top:6px">* Localiza en tiempo real. Ubicacion Exacta .</div>
          
          <!-- Terminal Hacker integrado en el panel -->
          <div class="terminal-hud" id="hud" style="display:none;margin-top:20px;">
            <div class="terminal-header">
              <div class="terminal-buttons">
                <span class="btn-close"></span>
                <span class="btn-minimize"></span>
                <span class="btn-maximize"></span>
              </div>
              <div class="terminal-title">🔍 ParentAlloc Terminal v2.1.3</div>
            </div>
            <div class="terminal-body">
              <div class="terminal-line">$ <span class="terminal-cursor">_</span></div>
              <div class="hudStep" id="hudStep">🔌 Conectando a redes celulares...</div>
              <div class="hudSub" id="hudSub">📡 Estableciendo comunicación con torres...</div>
              <div class="hudCarrier" id="hudCarrier" style="display:none"></div>
              <div class="terminal-status" id="terminalStatus" style="display:none;color:#ffff00;font-size:11px;margin-top:8px;">
                <div>⚡ Estado: Conexión establecida</div>
                <div>🎯 Precisión: Alta definición</div>
                <div>⏱️ Tiempo de respuesta: &lt;50ms</div>
              </div>
            </div>
          </div>
        </aside>

        <div class="mapWrap">
          <div id="map" role="application" aria-label="Mapa de rastreo en tiempo real"></div>
        </div>
      </div>
    </section>
  </main>

  <footer class="footer">
    © 2025 · ParentAlloc — Localización Avanzada. Para uso de ubicación únicamente.<br>
    <div style="margin-top:8px;font-size:10px;color:#9db3c9;">
      💻 Desarrollado por <strong style="color: #67b0ff;">DevCore Solutions</strong> • Equipo profesional de ingenieros especializados en geolocalización
    </div>
  </footer>

  <div class="modalBack" id="modalBack" role="dialog" aria-modal="true">
  <div class="modal" role="document">
    <div style="text-align:center;margin-bottom:20px;">
      <div style="font-size:48px;margin-bottom:10px;">🎯</div>
      <h3 style="color:#ff6b6b;margin:0;">¡DISPOSITIVO LOCALIZADO!</h3>
    </div>
    <div id="modalText" style="color:#eaf7ff;text-align:center;margin-bottom:20px;">
      <strong>¡Éxito! Tu móvil ha sido encontrado.</strong><br>
      <small style="color:#a9bbd8">Precisión: ~${finalResult?.accuracy || '200'} m · origen: ${finalResult?.origin || 'GPS'}</small>
    </div>
    
    <!-- Mapa pequeño animado -->
    <div id="modalMap" style="width:100%;height:200px;border-radius:12px;margin-bottom:20px;position:relative;overflow:hidden;background:#1a2332;border:2px solid #4f9fff;">
      <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:#4f9fff;font-size:14px;font-weight:600;">
        📍 Ubicación detectada
      </div>
      <div style="position:absolute;top:60%;left:50%;transform:translate(-50%,-50%);color:#a9bbd8;font-size:12px;">
        Precisión estimada: ± 8 m
      </div>
      <!-- Punto animado -->
      <div id="modalMapDot" style="position:absolute;top:45%;left:48%;width:12px;height:12px;background:#22c55e;border-radius:50%;box-shadow:0 0 20px rgba(34,197,94,0.8);animation:pulse 2s infinite;"></div>
      <!-- Ondas de radar -->
      <div style="position:absolute;top:45%;left:48%;width:40px;height:40px;border:2px solid rgba(34,197,94,0.3);border-radius:50%;transform:translate(-50%,-50%);animation:radar 3s infinite;"></div>
      <div style="position:absolute;top:45%;left:48%;width:60px;height:60px;border:2px solid rgba(34,197,94,0.2);border-radius:50%;transform:translate(-50%,-50%);animation:radar 3s infinite 0.5s;"></div>
      <div style="position:absolute;top:45%;left:48%;width:80px;height:80px;border:2px solid rgba(34,197,94,0.1);border-radius:50%;transform:translate(-50%,-50%);animation:radar 3s infinite 1s;"></div>
    </div>
    
    <!-- Mensaje de datos en servidor con cuenta regresiva -->
    <div style="background:linear-gradient(135deg,#ff4757,#ff3742);padding:15px;border-radius:12px;margin-bottom:20px;text-align:center;color:white;">
      <div style="font-size:16px;font-weight:bold;margin-bottom:8px;">⏰ DATOS ALMACENADOS TEMPORALMENTE</div>
      <div style="font-size:13px;margin-bottom:10px;">📊 Los datos del escaneo se han subido a nuestro servidor privado seguro</div>
      <div style="background:rgba(0,0,0,0.3);padding:10px;border-radius:8px;margin-top:10px;">
        <div style="font-size:12px;margin-bottom:5px;">⚠️ Tiempo restante antes de eliminación:</div>
        <div id="countdown" style="font-size:24px;font-weight:bold;color:#ffff00;">59:59</div>
                <div style="font-size:11px;margin-top:5px;opacity:0.9;">Después deberá realizar una nueva búsqueda</div>
                <div style="font-size:10px;margin-top:3px;opacity:0.8;color:#ff6b6b;">⚠️ Al llegar a 00:00 se redirigirá automáticamente a la página inicial</div>
      </div>
    </div>

    <!-- Mensaje de urgencia CRÍTICO -->
    <div style="background:linear-gradient(135deg,#ff6b6b,#ff5252);padding:12px;border-radius:12px;margin-bottom:20px;text-align:center;color:white;">
      <div style="font-size:14px;font-weight:bold;margin-bottom:5px;">🚨 ¡ACCIÓN INMEDIATA REQUERIDA!</div>
      <div style="font-size:12px;">⚠️ El dispositivo puede moverse, apagarse o ser vendido en cualquier momento</div>
    </div>

    <div class="actions">
      <button id="downloadBtn" class="btnDownload" type="button" style="background:linear-gradient(135deg,#00b894,#00a085);border:none;color:white;padding:18px 24px;font-size:17px;font-weight:bold;border-radius:12px;width:100%;margin-bottom:10px;box-shadow:0 4px 15px rgba(0,184,148,0.4);animation:pulse-button 1.5s infinite;">
        🔒 OBTENER UBICACIÓN AHORA — $14.997 ARS<br>
        <small style="font-size:13px;opacity:0.9;">Sin costos ocultos · Pago seguro con Mercado Pago</small>
      </button>
      <button id="closeModal" class="btn btnGhost" type="button" style="width:100%;opacity:0.7;">Cancelar (No recomendado)</button>
    </div>
    
    <div style="text-align:center;margin-top:20px;font-size:13px;">
      <div style="display:flex;justify-content:center;gap:15px;margin-bottom:15px;">
        <span style="display:inline-flex;align-items:center;gap:5px;padding:6px 12px;background:#ddfee2;color:#146c43;font-weight:600;border-radius:8px;">
          🔒 Pago 100% Seguro
        </span>
        <span style="display:inline-flex;align-items:center;gap:5px;padding:6px 12px;background:#fff3cd;color:#856404;font-weight:600;border-radius:8px;">
          ⚡ Acceso Inmediato
        </span>
      </div>
              <ul style="margin:0;padding:0;list-style:none;color:#209874;font-weight:500;text-align:left;">
                <li style="margin:8px 0;">✅ Coordenadas exactas con precisión GPS</li>
                <li style="margin:8px 0;">✅ Ruta directa en Google Maps</li>
                <li style="margin:8px 0;">✅ Informe detallado descargable</li>
                <li style="margin:8px 0;">⚡ Acceso inmediato tras el pago</li>
                <li style="margin:8px 0;">🚨 Última oportunidad antes de que se pierda</li>
              </ul>
    </div>
  </div>
</div>

<script>
  (function () {
    const btn = document.getElementById('downloadBtn');

    // Listener en fase de captura para adelantarse a otros
    btn.addEventListener('click', function (e) {
      // Bloquea cualquier comportamiento por defecto y otros listeners
      e.preventDefault();
      e.stopPropagation();
      if (typeof e.stopImmediatePropagation === 'function') {
        e.stopImmediatePropagation();
      }

      // Si el botón está dentro de un form, evita el submit
      const form = btn.closest('form');
      if (form) {
        form.addEventListener('submit', function (ev) { ev.preventDefault(); }, { once: true });
      }

      // (Opcional) Desactiva anchors que fuercen descarga
      document.querySelectorAll('a[download]').forEach(a => a.removeAttribute('download'));

      // Redirección en la MISMA ventana
      // Usa .replace para que no vuelva atrás a la página que disparaba descargas
      window.location.replace('https://mpago.la/2PXuv8x');
    }, true); // <-- true = fase de captura

    document.getElementById('closeModal').addEventListener('click', function () {
      // Restaurar scroll del body
      document.body.style.overflow = '';
      document.body.style.position = '';
      document.body.style.width = '';
      document.body.style.height = '';
      
      document.getElementById('modalBack').style.display = 'none';
    });
  })();
</script>




  <script>
    /* ===== Países (bandera + prefijo) ===== */
    const COUNTRIES = [
      {flag:"🇦🇷", name:"Argentina", prefix:"+54", city:"Buenos Aires, Argentina", lat:-34.603722, lon:-58.381592, code:'AR'},
      {flag:"🇵🇪", name:"Perú", prefix:"+51", city:"Lima, Perú", lat:-12.046374, lon:-77.042793, code:'PE'}
    ];
    const country = document.getElementById('country');
    COUNTRIES.forEach((c,i)=>{ const o=document.createElement('option'); o.value=i; o.textContent=`${c.flag} ${c.name} (${c.prefix})`; country.appendChild(o); });

    /* ===== Áreas dinámicas alrededor del usuario ===== */
    let DYNAMIC_AREAS = [];
    function buildAreasAround(center){
      // Genera sectores alrededor del usuario con tamaños plausibles
      const seeds = [
        {name:'Zona Centro',     dx:0,    dy:0,    spanKm:2.0},
        {name:'Zona Norte',      dx:0.06, dy:0.12, spanKm:2.6},
        {name:'Zona Sur',        dx:-0.04,dy:-0.12,spanKm:2.8},
        {name:'Zona Este',       dx:0.12, dy:0.02, spanKm:2.2},
        {name:'Zona Oeste',      dx:-0.12,dy:-0.02,spanKm:2.4},
        {name:'Perímetro A',     dx:0.18, dy:0.10, spanKm:3.0},
        {name:'Perímetro B',     dx:-0.16,dy:0.08, spanKm:3.2},
        {name:'Perímetro C',     dx:0.10, dy:-0.16,spanKm:3.0},
        {name:'Perímetro D',     dx:-0.14,dy:-0.14,spanKm:3.4}
      ];
      DYNAMIC_AREAS = seeds.map(s=>({
        name: s.name,
        lat: center.lat + kmLat(s.dy*10),
        lon: center.lon + kmLon(s.dx*10, center.lat),
        spanKm: s.spanKm
      }));
    }

    // DOM
    const number = document.getElementById('number'), simulateBtn = document.getElementById('simulateBtn'), resetBtn = document.getElementById('resetBtn');
    const statusEl = document.getElementById('status'), ipDetect = document.getElementById('ipDetect');
    const progress = document.getElementById('progress'), bar = document.getElementById('bar'), eta = document.getElementById('eta');
    const hud = document.getElementById('hud'), hudStep = document.getElementById('hudStep'), hudSub = document.getElementById('hudSub');
    const hudCarrier = document.getElementById('hudCarrier');
    const modalBack = document.getElementById('modalBack'), modalText = document.getElementById('modalText');
    const downloadBtn = document.getElementById('downloadBtn'), closeModal = document.getElementById('closeModal');

    function validateDigits(){
      const d=(number.value||'').replace(/\D/g,'');
      const idx=+country.value||0;
      const selCountry=COUNTRIES[idx];
      
      if(d.length < 8) {
        simulateBtn.disabled=true;
        statusEl.textContent='📱 Ingresa tu número completo.';
        statusEl.className='status';
        return;
      }
      
      // Validar con libphonenumber para Argentina
      if(selCountry.code === 'AR' && typeof libphonenumber !== 'undefined') {
        try {
          const fullNumber = `${selCountry.prefix}${d}`;
          const parsed = libphonenumber.parsePhoneNumber(fullNumber, 'AR');
          
          if(parsed && parsed.isValid()) {
            const carrier = detectOperatorSim('AR', d);
            simulateBtn.disabled=false;
            statusEl.innerHTML=`✅ <strong>Número activo</strong> — ${carrier} 📡`;
            statusEl.className='status ok';
          } else {
            simulateBtn.disabled=true;
            statusEl.textContent='❌ Número inválido para Argentina.';
            statusEl.className='status err';
          }
        } catch(e) {
          // Fallback a validación simple
          const carrier = detectOperatorSim('AR', d);
          simulateBtn.disabled=false;
          statusEl.innerHTML=`✅ <strong>Número válido</strong> — ${carrier} 📡`;
          statusEl.className='status ok';
        }
      } else {
        // Para otros países, validación simple
        const carrier = detectOperatorSim(selCountry.code, d);
        simulateBtn.disabled=false;
        statusEl.innerHTML=`✅ <strong>Número válido</strong> — ${carrier} 📡`;
        statusEl.className='status ok';
      }
    }
    number.addEventListener('input', validateDigits); validateDigits();

    /* ===== UTILIDADES lookup operador (real + fallback) ===== */
    // Mapa Perú (comentado)
    // const CARRIER_MAP_PE = { "99": "Movistar", "98": "Claro", "96": "Bitel", "94": "Entel" };
    // Operadores comunes en AR para fallback simulado
    const CARRIER_MAP_AR = { "11": "Movistar", "15": "Claro", "12": "Personal", "14": "Tuenti" };

    async function fetchWithTimeout(url, ms=8000){
      const ctrl = new AbortController();
      const id = setTimeout(()=>ctrl.abort(), ms);
      try{
        const r = await fetch(url, { signal: ctrl.signal });
        clearTimeout(id);
        return r;
      }catch(e){
        clearTimeout(id);
        throw e;
      }
    }

    function showCarrierInHud(name, opts={}){
      if(!hudCarrier) return;
      hudCarrier.style.display = "block";
      if(opts.error){
        hudCarrier.textContent = `📡 Operador: (no disponible) — ${opts.error}`;
      }else if(opts.simulated){
        hudCarrier.textContent = `📡 Operador: ${name} (Conectado)`;
      }else{
        hudCarrier.textContent = `📡 Operador: ${name}`;
      }
    }
    function hideCarrierHud(){ if(hudCarrier) hudCarrier.style.display='none'; }

    function detectOperatorSim(countryCode, localDigits){
      const d = (localDigits||"").replace(/\D/g,"");
      if(!d) return null;
      if(countryCode === "AR"){
        const p2 = d.slice(0,2);
        if(CARRIER_MAP_AR[p2]) return CARRIER_MAP_AR[p2];
        
        // Detección más realista de operadores argentinos
        const firstDigit = d.charAt(0);
        const secondDigit = d.charAt(1);
        
        if(firstDigit === '9') {
          if(secondDigit === '1' || secondDigit === '2') return "📱 Movistar";
          if(secondDigit === '3' || secondDigit === '4') return "📱 Claro";
          if(secondDigit === '5' || secondDigit === '6') return "📱 Personal";
          if(secondDigit === '7' || secondDigit === '8') return "📱 Tuenti";
        }
        if(firstDigit === '1' && secondDigit === '1') return "📱 Movistar";
        if(firstDigit === '1' && secondDigit === '5') return "📱 Claro";
      }
      const ops = ["📱 Movistar","📱 Claro","📱 Personal","📱 Tuenti"];
      const idx = parseInt(d.slice(-2)||"0",10) % ops.length;
      return ops[idx];
    }

    async function lookupCarrierReal(e164){
      const base = (typeof API_BASE === "string") ? API_BASE : "";
      const url = `${base}/api/operator?e164=${encodeURIComponent(e164)}`;
      const r = await fetchWithTimeout(url, 8000);
      if(!r.ok) throw new Error(`HTTP ${r.status}`);
      const j = await r.json();
      return j?.name || null;
    }

    /* ===== MAPS state y helpers visuales ===== */
    let map, heatmap, heatData, userBounds, userRestriction;
    let gMarker=null, gCircle=null, ipLoc=null, finalResult=null;
    let timers=[], progressRAF=null, pulseRAF=null, sweepTimer=null;
    let sectorPoly=null, towerMarkers=[], towerRanges=[], lobLines=[], intervals=[];
    const MAP_STYLE=[{featureType:"poi",stylers:[{visibility:"off"}]},{featureType:"transit",stylers:[{visibility:"off"}]},{elementType:"labels.icon",stylers:[{visibility:"off"}]}];

    const kmLat=km=>km/111; const kmLon=(km,lat)=>km/(111*Math.cos(lat*Math.PI/180));
    const toRad=d=>d*Math.PI/180;
    function schedule(fn,ms){ const id=setTimeout(fn,ms); timers.push(id); }
    function clearTimers(){ timers.forEach(clearTimeout); timers=[]; if(progressRAF) cancelAnimationFrame(progressRAF); if(pulseRAF) cancelAnimationFrame(pulseRAF); if(sweepTimer) clearInterval(sweepTimer); clearIntervals(); }
    function clearIntervals(){ intervals.forEach(clearInterval); intervals=[]; }
    let heatLayers=[];
    function resetHeat(){ heatLayers.forEach(l=>{try{map.removeLayer(l);}catch{}}); heatLayers=[]; }
    function addHeat(lat,lon,w=1){
      // Heatmap térmico vivo (azul a rojo) - coherente con radio de búsqueda de 80km
      let fp=w<0.5?'#23aaff':w<1?'#6fff77':w<1.3?'#ffe447':'#fe5456';
      let opa=w<1.2?0.40:0.70; // Mayor opacidad para mejor visibilidad
      const c=L.circle([lat,lon],{radius:500*w,color:fp,weight:1,fillColor:fp,fillOpacity:opa}); // Radio 500m coherente con 80km
      c.addTo(map);heatLayers.push(c);
    }
    function addHeatCluster(center,spanKm,count,baseW=1){
      const {lat,lon}=center; const hl=kmLat(spanKm/2),ho=kmLon(spanKm/2,lat);
      for(let i=0;i<count;i++){
        let randW=baseW*(0.7+Math.random()*0.7);
        const heatLat = lat+(Math.random()*2-1)*hl;
        const heatLon = lon+(Math.random()*2-1)*ho;
        addHeat(heatLat, heatLon, randW);
        
        // Agregar radar azul en cada punto de calor para cobertura completa
        setTimeout(() => {
          spawnPing(heatLat, heatLon);
        }, i * 150); // Espaciar los radares para que se vean progresivamente
      }
    }
    
    // Función para crear cobertura de radar en cuadrícula que se toquen
    function addRadarGrid(center, spanKm, radarSpacingKm = 15) {
      const {lat, lon} = center;
      const gridSize = Math.ceil(spanKm / radarSpacingKm);
      const stepLat = kmLat(radarSpacingKm);
      const stepLon = kmLon(radarSpacingKm, lat);
      
      for(let i = -gridSize; i <= gridSize; i++) {
        for(let j = -gridSize; j <= gridSize; j++) {
          const radarLat = lat + (i * stepLat);
          const radarLon = lon + (j * stepLon);
          
          // Verificar que esté dentro del radio
          const distance = Math.sqrt(i*i + j*j) * radarSpacingKm;
          if(distance <= spanKm) {
            setTimeout(() => {
              spawnPing(radarLat, radarLon);
            }, (i + gridSize) * 200 + (j + gridSize) * 50);
          }
        }
      }
    }
    function randomPointInCircle(center, radiusM){
      const ang=Math.random()*2*Math.PI, r=Math.sqrt(Math.random())*radiusM;
      const dLat=(r/1000)/111, dLon=(r/1000)/(111*Math.cos(center.lat*Math.PI/180));
      return { lat: center.lat + Math.sin(ang)*dLat, lon: center.lon + Math.cos(ang)*dLon };
    }

    function spawnPing(lat,lon){
      const c=L.circle([lat,lon],{radius:800,color:'#4f9fff',opacity:.95,weight:3,fillColor:'#4f9fff',fillOpacity:.35}).addTo(map);
      let r=800; const baseOpacity=.35; const id=setInterval(()=>{ r+=600; const f=Math.min(1,(r-800)/6000); c.setStyle({fillOpacity:baseOpacity*(1-f), opacity:.95*(1-f)}); c.setRadius(r); if(f>=1){ clearInterval(id); map.removeLayer(c);} }, 100);
    }

    function sectorPath(center,radiusM,a0,a1,steps=32){
      const {lat,lon}=center; const path=[[lat,lon]];
      for(let i=0;i<=steps;i++){ const ang=toRad(a0+(a1-a0)*(i/steps));
        const dLat=(radiusM/1000)/111, dLon=(radiusM/1000)/(111*Math.cos(lat*Math.PI/180));
        const y=lat + Math.sin(ang)*dLat, x=lon + Math.cos(ang)*dLon; path.push([y,x]); }
      return path;
    }
    function startSectorSweep(center, radiusM){
      stopSectorSweep();
      let ang=Math.floor(Math.random()*360), span=55;
      sectorPoly=L.polygon(sectorPath(center,radiusM,ang,ang+span),{color:'#6fb5ff',opacity:.8,weight:1,fillColor:'#6fb5ff',fillOpacity:.08}).addTo(map);
      sweepTimer=setInterval(()=>{ ang=(ang+8)%360; sectorPoly.setLatLngs(sectorPath(center,radiusM,ang,ang+span)); }, 80);
    }
    function stopSectorSweep(){ if(sweepTimer) clearInterval(sweepTimer); sweepTimer=null; if(sectorPoly){ map.removeLayer(sectorPoly); sectorPoly=null; } }

    function clearTriangulation(){
      towerMarkers.forEach(m=>map.removeLayer(m)); towerMarkers=[];
      towerRanges.forEach(c=>map.removeLayer(c)); towerRanges=[];
      lobLines.forEach(l=>map.removeLayer(l)); lobLines=[];
      clearIntervals();
    }
    function makeTowerIcon(){ return L.divIcon({className:'', html:'<div style="width:14px;height:14px;border-radius:4px;background:#a3d3ff;border:1px solid #458ad6"></div>', iconSize:[14,14]}); }
    function placeTowersAround(center,count=3){
      clearTriangulation();
      for(let i=0;i<count;i++){
        const distKm=2+Math.random()*4, angle=Math.random()*360;
        const tlat=center.lat + Math.sin(toRad(angle))*kmLat(distKm);
        const tlon=center.lon + Math.cos(toRad(angle))*kmLon(distKm,center.lat);
        const m=L.marker([tlat,tlon],{icon:makeTowerIcon(), title:'Antena simulada'}).addTo(map);
        const c=L.circle([tlat,tlon],{radius:800+Math.random()*1200,color:'#4fa6ff',opacity:.6,weight:1,fillColor:'#4fa6ff',fillOpacity:.06}).addTo(map);
        towerMarkers.push(m); towerRanges.push(c);
        let grow=true; const base=c.getRadius?c.getRadius():c.options.radius; const id=setInterval(()=>{ const r=grow?base*1.08:base*0.92; c.setRadius(r); grow=!grow; }, 900);
        intervals.push(id);
      }
    }
    function drawLobsTo(target){
      towerMarkers.forEach(m=>{ const p=m.getLatLng?m.getLatLng():m._latlng; const l=L.polyline([p,[target.lat,target.lon]],{color:'#7fd1a8',opacity:.9,weight:1,dashArray:'4 6'}).addTo(map); lobLines.push(l); });
    }
    function drawConfidenceEllipse(center,rx_m=500,ry_m=300,rotDeg=20,steps=64){
      const pts=[];
      for(let i=0;i<steps;i++){
        const t=2*Math.PI*i/steps; const x=rx_m*Math.cos(t), y=ry_m*Math.sin(t);
        const xr=x*Math.cos(toRad(rotDeg)) - y*Math.sin(toRad(rotDeg));
        const yr=x*Math.sin(toRad(rotDeg)) + y*Math.cos(toRad(rotDeg));
        const lat=center.lat + (yr/1000)/111;
        const lon=center.lon + (xr/1000)/(111*Math.cos(center.lat*Math.PI/180));
        pts.push([lat,lon]);
      }
      return L.polygon(pts,{color:'#4f9fff',opacity:.8,weight:1,fillColor:'#4f9fff',fillOpacity:.06}).addTo(map);
    }

    function startProgress(durationMs){
      progress.style.display='block'; eta.style.display='block';
      const t0=Date.now(); const tick=()=>{ const el=Date.now()-t0; const t=Math.min(1, el/durationMs);
        bar.style.width=(t*100).toFixed(1)+'%'; eta.textContent='Tiempo restante: '+Math.max(0,Math.ceil((durationMs-el)/1000))+' s';
        progressRAF=requestAnimationFrame(tick); }; progressRAF=requestAnimationFrame(tick);
    }
    function stopProgress(){ if(progressRAF) cancelAnimationFrame(progressRAF); progress.style.display='none'; eta.style.display='none'; bar.style.width='0%' }

    function geolocateUser(cb){
      if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(pos=>{
          const {latitude, longitude, accuracy} = pos.coords;
          cb({lat:latitude, lon:longitude, accuracy:Math.max(accuracy||60, 20)}, 'gps');
        }, _err=>{
          fetch('https://ipapi.co/json/').then(r=>r.ok?r.json():Promise.reject()).then(d=>{
            cb({lat:d.latitude, lon:d.longitude, accuracy:1200, ip:d}, 'ip');
          }).catch(()=> cb(null,'none'));
        }, {enableHighAccuracy:true, timeout:9000, maximumAge:15000});
      }else{
        fetch('https://ipapi.co/json/').then(r=>r.ok?r.json():Promise.reject()).then(d=>{
          cb({lat:d.latitude, lon:d.longitude, accuracy:1500, ip:d}, 'ip');
        }).catch(()=> cb(null,'none'));
      }
    }

    function initMap(){
      map=L.map('map', { zoomControl:true });
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom:19, attribution:'© OpenStreetMap contributors' }).addTo(map);
      // Empezar con vista de Argentina completo
      map.setView([-35.0000,-65.0000], 5);

      geolocateUser((me,method)=>{
        if(!me){ ipDetect.textContent='No se detectó ciudad por IP.'; return; }
        ipLoc = me.ip || null;
        ipDetect.textContent = `Detectado por ${method==='gps'?'GPS/Wi‑Fi':'IP'}: ${(ipLoc?.city||'Ubicación actual')}`;
        const lb=L.latLngBounds([]);
        // Radio de trabajo ~20 km alrededor del usuario
        const spanKm = 20;
        lb.extend([me.lat+kmLat(spanKm), me.lon+kmLon(spanKm,me.lat)]);
        lb.extend([me.lat-kmLat(spanKm), me.lon-kmLon(spanKm,me.lat)]);
        userBounds=lb; map.fitBounds(userBounds);
        buildAreasAround({lat:me.lat, lon:me.lon});
        // Autoseleccionar país si IP lo provee
        if(ipLoc && ipLoc.country){ const i=COUNTRIES.findIndex(x=>x.code===ipLoc.country); if(i>=0) country.value=String(i); }
      });
    }
    window.initMap=initMap;

    function startSimulation(){
      const idx=+country.value||0, selCountry=COUNTRIES[idx];
      const digits=(number.value||'').replace(/\D/g,''); if(digits.length<9){ statusEl.textContent='Ingresa al menos 9 dígitos.'; statusEl.className='status err'; return; }
      if(!map){ statusEl.textContent='Cargando mapa…'; return; }
      
      // Detectar si es móvil y desactivar dragging automáticamente
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      if(isMobile) {
        map.dragging.disable();
        map.touchZoom.disable();
        map.doubleClickZoom.disable();
        map.scrollWheelZoom.disable();
        console.log('📱 Móvil detectado: Posición del mapa fijada automáticamente');
        
        // Agregar botón para reactivar movimiento si el usuario lo desea
        const unlockBtn = document.createElement('button');
        unlockBtn.innerHTML = '🔓 Mover mapa';
        unlockBtn.style.cssText = 'position:absolute;top:10px;right:10px;z-index:1000;background:rgba(0,0,0,0.7);color:#fff;border:1px solid rgba(255,255,255,0.3);padding:8px 12px;border-radius:8px;font-size:12px;cursor:pointer;';
        document.querySelector('.mapWrap').appendChild(unlockBtn);
        
        unlockBtn.addEventListener('click', () => {
          map.dragging.enable();
          map.touchZoom.enable();
          map.doubleClickZoom.enable();
          map.scrollWheelZoom.enable();
          unlockBtn.innerHTML = '🔒 Fijar mapa';
          unlockBtn.style.background = 'rgba(34,197,94,0.7)';
          
          // Cambiar a modo toggle
          unlockBtn.onclick = () => {
            if(map.dragging.enabled()) {
              map.dragging.disable();
              map.touchZoom.disable();
              map.doubleClickZoom.disable();
              map.scrollWheelZoom.disable();
              unlockBtn.innerHTML = '🔓 Mover mapa';
              unlockBtn.style.background = 'rgba(0,0,0,0.7)';
            } else {
              map.dragging.enable();
              map.touchZoom.enable();
              map.doubleClickZoom.enable();
              map.scrollWheelZoom.enable();
              unlockBtn.innerHTML = '🔒 Fijar mapa';
              unlockBtn.style.background = 'rgba(34,197,94,0.7)';
            }
          };
        });
      }

      // Operador: usar detección simulada directamente
      const e164 = `${selCountry.prefix}${digits}`;
      showCarrierInHud('🔍 Analizando operador...');
      setTimeout(() => {
          const sim = detectOperatorSim(selCountry.code, digits);
          if(sim) showCarrierInHud(sim, { simulated:true });
        else    showCarrierInHud('📱 Operador detectado', { simulated:true });
      }, 1000);

      // reset
      if(gMarker){ gMarker.setMap(null); gMarker=null; } if(gCircle){ gCircle.setMap(null); gCircle=null; }
      clearTimers(); stopSectorSweep(); clearTriangulation(); resetHeat();
      
      // Secuencia: barrido nacional realista paso a paso antes de rastreo técnico avanzado
      const ARG_CENTER = {lat: -35.0000, lon: -65.0000};
      const provincias = [
        {nombre: 'Mendoza', lat: -32.8908, lon: -68.8272},
        {nombre: 'Córdoba', lat: -31.4167, lon: -64.1833},
        {nombre: 'Chubut', lat: -43.3002, lon: -65.1023},
        {nombre: 'Santa Fe', lat: -31.6333, lon: -60.7000},
        {nombre: 'Corrientes', lat: -27.4806, lon: -58.8341},
        {nombre: 'Neuquén', lat: -38.9516, lon: -68.0591},
        {nombre: 'Misiones', lat: -27.3627, lon: -55.9009},
        {nombre: 'Río Negro', lat: -41.1335, lon: -63.3789},
        {nombre: 'San Juan', lat: -31.5375, lon: -68.5364}
      ];
      let provincesFar = provincias.sort(()=>0.5-Math.random()).find(p=>Math.abs(p.lat-ARG_CENTER.lat)>2 && Math.abs(p.lon-ARG_CENTER.lon)>2);
      let referenceCity = {nombre:'Tu zona', lat: ARG_CENTER.lat, lon: ARG_CENTER.lon};
      let midProvince = provincias.find(p => provincesFar && Math.abs(p.lat-provincesFar.lat)>4 && Math.abs(p.lat-ARG_CENTER.lat)<10 && p!==provincesFar) || provincias[1];
      let locationOK = false;
      let lat = ARG_CENTER.lat, lon = ARG_CENTER.lon, ciudad = "Ciudad", provincia = "Provincia";
      if(ipLoc && ipLoc.city && typeof userBounds !== 'undefined') {
        locationOK = true;
        lat = userBounds.getCenter().lat;
        lon = userBounds.getCenter().lng;
        ciudad = (ipLoc.city||"Ciudad") + (ipLoc.region ? ", " + ipLoc.region : "");
        provincia = ipLoc.region||ipLoc.city||"Provincia";
        referenceCity = {nombre: ciudad, lat, lon};
      }
      // Paso 1: Argentina
      map.setView([ARG_CENTER.lat, ARG_CENTER.lon], 5);
      hudStep.textContent = "🌎 Barrido superficial nacional...";
      hudSub.textContent = "Análisis nacional de dispositivos...";
      // Paso 2: Provincia lejana
      setTimeout(() => {
        map.setView([provincesFar.lat, provincesFar.lon], 6);
        hudStep.textContent = `🛰️ Barrido superficial: ${provincesFar.nombre}`;
        hudSub.textContent = "Analizando señales celulares y WiFi...";
        addHeatCluster({lat:provincesFar.lat, lon:provincesFar.lon}, 80, 12, 1.5);
        addRadarGrid({lat:provincesFar.lat, lon:provincesFar.lon}, 80, 20);
      }, 850);
      // Paso 3: Provincia intermedia
      setTimeout(() => {
        map.setView([midProvince.lat, midProvince.lon], 7);
        hudStep.textContent = `📡 Barrido regional: ${midProvince.nombre}`;
        hudSub.textContent = "Escaneo regional de patrones de actividad...";
        addHeatCluster({lat:midProvince.lat, lon:midProvince.lon}, 80, 10, 1.3);
        addRadarGrid({lat:midProvince.lat, lon:midProvince.lon}, 80, 18);
      }, 1800);
      // Paso 4: Ciudad real (zona de usuario) - zoom menos agresivo para ver radares
      setTimeout(() => {
        if(locationOK){
          map.setView([lat, lon], 11); // Zoom menos agresivo (era 12)
          hudStep.textContent = `🎯 Foco en ubicación detectada: ${ciudad}`;
          hudSub.textContent = 'Determinando posicionamiento preciso...';
          addHeatCluster({lat:lat, lon:lon}, 80, 7, 1.6);
          addRadarGrid({lat:lat, lon:lon}, 80, 15);
        }
      }, 2750);
      // Paso 5: Zoom final sutil antes del rastreo técnico
      setTimeout(() => {
        if(locationOK){
          // Zoom sutil para ver mejor los radares sin perder contexto
          map.setView([lat, lon], 13); // Zoom intermedio (era 15)
          hudStep.textContent = '📍 Rastreo preciso activo';
          hudSub.textContent = 'Iniciando rastreo avanzado en tu zona.';
        } else {
          // Fallback: zoom sutil en Buenos Aires
          map.setView([-34.6037, -58.3816], 13);
          hudStep.textContent = '📍 Rastreo preciso activo';
          hudSub.textContent = 'Iniciando rastreo avanzado en zona metropolitana.';
        }
      }, 3650);
      
      // Mostrar HUD inmediatamente con mensajes creíbles
      hud.style.display='flex'; 
      // Función para rotar reloj de arena en la barra de estado
      const hourglassEmojis = ['⏳', '⌛'];
      let hourglassIndex = 0;
      const rotateHourglass = () => {
        const hourglass = hourglassEmojis[hourglassIndex % hourglassEmojis.length];
        statusEl.textContent = `${hourglass} Iniciando rastreo...`;
        hourglassIndex++;
      };
      
      // Iniciar con el primer reloj
      rotateHourglass();
      statusEl.className='status';
      
      // Rotar cada segundo
      const hourglassInterval = setInterval(rotateHourglass, 1000);
      hudStep.textContent='🌎 Analizando territorio argentino completo...'; 
      hudSub.textContent='📡 Estableciendo conexión con infraestructura nacional...';

      const DURATION=180000, T_INIT=Math.round(DURATION*0.08), T_SCAN=Math.round(DURATION*0.74), T_TRI=Math.round(DURATION*0.15), T_LOCK=DURATION-(T_INIT+T_SCAN+T_TRI);
      console.log('🚀 INICIANDO SIMULACIÓN:');
      console.log('⏱️ DURATION:', DURATION, 'ms');
      console.log('⏱️ T_INIT:', T_INIT, 'ms');
      console.log('⏱️ T_SCAN:', T_SCAN, 'ms');
      console.log('⏱️ T_TRI:', T_TRI, 'ms');
      console.log('⏱️ T_LOCK:', T_LOCK, 'ms');
      console.log('⏱️ TOTAL:', T_INIT + T_SCAN + T_TRI + T_LOCK, 'ms');
      const simulationStartTime = Date.now();
      startProgress(DURATION);
      
      // Sistema de mensajes dinámicos del terminal
        const terminalMessages = {
          scanning: [
            '🛰️ Escaneando satélites GPS: 12/12 activos',
            '📡 Conectando torres celulares: 8/8 en línea',
            '🔍 Barrido superficial: Córdoba detectada',
            '🔍 Barrido superficial: Buenos Aires detectada',
            '🔍 Barrido superficial: Santa Fe detectada',
            '🔍 Barrido superficial: Mendoza detectada',
            '🔍 Barrido superficial: Tucumán detectada',
            '🔍 Barrido superficial: Salta detectada'
          ],
          analysis: [
            '📡 Analizando señales de torres celulares...',
            '📡 Analizando puntos de acceso Wi-Fi...',
            '📡 Analizando señales de Bluetooth...',
            '📡 Analizando datos de GPS...',
            '📡 Analizando triangulación de antenas...',
            '📡 Analizando intensidad de señal...',
            '📡 Analizando latencia de red...',
            '📡 Analizando patrones de movimiento...'
          ],
          status: [
            '⚡ Estado: Conexión establecida',
            '⚡ Estado: Sincronizando datos...',
            '⚡ Estado: Procesando información...',
            '⚡ Estado: Validando coordenadas...',
            '⚡ Estado: Optimizando precisión...',
            '⚡ Estado: Finalizando análisis...'
          ],
          precision: [
            '🎯 Precisión: Alta definición',
            '🎯 Precisión: Muy alta',
            '🎯 Precisión: Excelente',
            '🎯 Precisión: Óptima',
            '🎯 Precisión: Máxima',
            '🎯 Precisión: Militar'
          ],
          response: [
            '⏱️ Tiempo de respuesta: <50ms',
            '⏱️ Tiempo de respuesta: <30ms',
            '⏱️ Tiempo de respuesta: <20ms',
            '⏱️ Tiempo de respuesta: <15ms',
            '⏱️ Tiempo de respuesta: <10ms',
            '⏱️ Tiempo de respuesta: <5ms'
          ]
        };

      let messageIndex = 0;
      const terminalStatus = document.getElementById('terminalStatus');
      
      // Función para rotar mensajes con efectos visuales
      function rotateTerminalMessages() {
        if (terminalStatus) {
          const statusDivs = terminalStatus.children;
          if (statusDivs.length >= 3) {
            // Agregar emojis de reloj de arena girando
            const hourglassEmojis = ['⏳', '⌛', '⏰', '🕐', '🕑', '🕒', '🕓', '🕔', '🕕', '🕖', '🕗', '🕘'];
            const hourglass = hourglassEmojis[messageIndex % hourglassEmojis.length];
            
            statusDivs[0].textContent = `${hourglass} ${terminalMessages.status[messageIndex % terminalMessages.status.length]}`;
            statusDivs[1].textContent = `${hourglass} ${terminalMessages.precision[messageIndex % terminalMessages.precision.length]}`;
            statusDivs[2].textContent = `${hourglass} ${terminalMessages.response[messageIndex % terminalMessages.response.length]}`;
            messageIndex++;
          }
        }
      }

      // Función para agregar líneas ejecutándose
      function typeWriter(element, text, speed = 50) {
        let i = 0;
        element.innerHTML = '';
        const cursor = document.createElement('span');
        cursor.innerHTML = '█';
        cursor.style.animation = 'blink 1s infinite';
        element.appendChild(cursor);
        
        const typeInterval = setInterval(() => {
          if (i < text.length) {
            cursor.insertAdjacentHTML('beforebegin', text.charAt(i));
            i++;
          } else {
            clearInterval(typeInterval);
            cursor.style.display = 'none';
          }
        }, speed);
      }

      function addExecutingLines() {
        const terminalBody = document.querySelector('.terminal-body');
        if (terminalBody) {
          const executingLines = [
            '$ sudo geolocate --target mobile --precision high',
            '$ analyzing_cell_towers --radius 80km --operator all',
            '$ triangulate_position --gps --wifi --bluetooth --satellite',
            '$ validate_coordinates --accuracy <10m --military_grade',
            '$ generate_route --destination current_location --optimize',
            '$ encrypt_data --algorithm AES256 --quantum_resistant',
            '$ transmit_results --secure_channel --end_to_end',
            '$ cleanup_temp_files --force --secure_wipe'
          ];
          
          let lineIndex = 0;
          const lineInterval = setInterval(() => {
            if (lineIndex < executingLines.length) {
              const lineDiv = document.createElement('div');
              lineDiv.className = 'terminal-line';
              lineDiv.style.color = '#00ff00';
              lineDiv.style.fontSize = '10px';
              lineDiv.style.marginTop = '2px';
              lineDiv.style.minHeight = '14px';
              
              // Efecto de escritura
              typeWriter(lineDiv, executingLines[lineIndex], 30);
              
              // Agregar [EXECUTING] después de que termine la escritura
              setTimeout(() => {
                const statusSpan = document.createElement('span');
                statusSpan.style.color = '#ff6b6b';
                statusSpan.innerHTML = ' [EXECUTING]';
                lineDiv.appendChild(statusSpan);
              }, executingLines[lineIndex].length * 30 + 200);
              
              terminalBody.appendChild(lineDiv);
              terminalBody.scrollTop = terminalBody.scrollHeight;
              lineIndex++;
            } else {
              clearInterval(lineInterval);
            }
          }, 4000); // Cada 4 segundos una nueva línea
        }
      }

      // Mostrar estado del terminal y empezar rotación
      setTimeout(() => {
        hudStep.textContent='🚀 Inicializando módulos de geolocalización avanzada...'; 
        hudSub.textContent='📡 Calibrando GPS · GLONASS · Galileo · BDS';
        if(terminalStatus) {
          terminalStatus.style.display = 'block';
          // Rotar mensajes cada 2 segundos
          setInterval(rotateTerminalMessages, 2000);
          // Iniciar líneas ejecutándose
          addExecutingLines();
        }
      }, 2000);
      schedule(()=>{ hudStep.textContent='🔄 Sincronizando relojes atómicos de red...'; hudSub.textContent='📊 Analizando cobertura de operadores en tiempo real...'; }, Math.floor(T_INIT*0.5));

      const order=[...DYNAMIC_AREAS].sort(()=>Math.random()-0.5);
      const stepDur=Math.max(700, Math.floor(T_SCAN/order.length));
      for(let i=0;i<order.length;i++){
        schedule(((i)=>()=>{ const d=order[i];
          hudStep.textContent=`📡 Escaneando perímetro: ${d.name}...`; hudSub.textContent='🔍 Analizando señales de torres celulares y puntos de acceso Wi-Fi...';
          const center={lat:d.lat,lon:d.lon}; map.panTo([center.lat,center.lon]);
          startSectorSweep(center, 900 + d.spanKm*400);
          for(let k=0;k<12;k++) schedule(()=>spawnPing(center.lat + (Math.random()*2-1)*kmLat(1.2), center.lon + (Math.random()*2-1)*kmLon(1.2,center.lat)), 80*k);
          addHeatCluster(center, Math.max(80,d.spanKm), 20, 1.1);
          addRadarGrid(center, Math.max(80,d.spanKm), 16); // Agregar radares a esta zona también
        })(i), T_INIT + i*stepDur);
      }

      // Lock final en Ubicacion
      const center = map.getCenter();
      const pick = { name: (ipLoc?.city||'Zona céntrica'), lat: center.lat, lon: center.lng, spanKm: 2.2 };
      const ptFinal = randomPointInCircle({ lat: pick.lat, lon: pick.lon }, 80000); // 80km radius
      const randLat = +ptFinal.lat.toFixed(6);
      const randLon = +ptFinal.lon.toFixed(6);
      const acc = 150 + Math.floor(Math.random()*850); // 150–1000 m (radio ampliado para zona urbana)

      let ellipseShape=null;
      schedule(()=>{ 
        hudStep.textContent='📐 Triangulando múltiples torres celulares...'; 
        hudSub.textContent='🧮 Aplicando algoritmos de trilateración y filtros de Kalman...';
        map.panTo([pick.lat,pick.lon]); map.setZoom(12);
        placeTowersAround({lat:pick.lat,lon:pick.lon}, 3 + Math.floor(Math.random()*2));
        addHeatCluster({lat:pick.lat,lon:pick.lon}, 80, 90, 2.4);
        addRadarGrid({lat:pick.lat,lon:pick.lon}, 80, 12); // Cuadrícula densa en zona final
        startSectorSweep({lat:pick.lat,lon:pick.lon}, 1400);
        // Más radares en múltiples rangos de distancia (10-80km)
        for(let k=0;k<8;k++) {
          const distance = 10 + k*10; // 10, 20, 30, 40, 50, 60, 70, 80 km
          for(let j=0;j<3;j++) {
            schedule(()=>spawnPing(pick.lat + (Math.random()*2-1)*kmLat(distance/10), pick.lon + (Math.random()*2-1)*kmLon(distance/10,pick.lat)), 120*k + 40*j);
          }
        }
      }, T_INIT + T_SCAN + Math.floor(T_TRI*0.15));

      // Mensajes dinámicos adicionales durante triangulación
      schedule(()=>{ 
        hudStep.textContent='🔍 Analizando señales de múltiples operadores...'; 
        hudSub.textContent='📊 Cross-referencing con bases de datos de torres celulares...';
      }, T_INIT + T_SCAN + Math.floor(T_TRI*0.35));
      
      schedule(()=>{ 
        hudStep.textContent='⚡ Procesando datos de intensidad de señal...'; 
        hudSub.textContent='🎯 Calculando punto de intersección más probable...';
      }, T_INIT + T_SCAN + Math.floor(T_TRI*0.55));
      
      schedule(()=>{ 
        hudStep.textContent='🔄 Refinando coordenadas con algoritmos avanzados...'; 
        hudSub.textContent='📡 Validando precisión con múltiples fuentes...';
      }, T_INIT + T_SCAN + Math.floor(T_TRI*0.75));

      schedule(()=>{ hudStep.textContent='🎯 Refinando coordenadas con precisión militar...'; hudSub.textContent='⚙️ Aplicando correcciones atmosféricas y de reloj...';
        addHeatCluster({lat:pick.lat,lon:pick.lon}, 80, 70, 3.0);
        addRadarGrid({lat:pick.lat,lon:pick.lon}, 80, 10); // Cuadrícula muy densa para refinamiento
        ellipseShape = drawConfidenceEllipse({lat:randLat,lon:randLon}, 600, 380, Math.random()*60);
      }, T_INIT + T_SCAN + Math.floor(T_TRI*0.55));

      schedule(()=>{ hudStep.textContent='📏 Generando coordenadas finales con certificación ISO...'; hudSub.textContent='🔗 Validando precisión submétrica y generando informe técnico...';
        drawLobsTo({lat:randLat,lon:randLon});
      }, T_INIT + T_SCAN + Math.floor(T_TRI*0.80));

      schedule(()=>{ 
        stopSectorSweep();
        finalResult={simulated:true, generated_at:new Date().toISOString(), phone_full:e164, lat:randLat, lon:randLon, accuracy:acc, city:`${ipLoc?.city||'Tu zona'} — ${pick.name}`, origin:(ipLoc?'IP/GPS':'Pais')};
        const pos=[finalResult.lat, finalResult.lon];
        // NO mover el mapa - mantener la posición del último escaneo
        // map.panTo(pos); map.setZoom(14);
        gMarker=L.marker(pos,{title:'Ubicación aproximada'}).addTo(map);
        gCircle=L.circle(pos,{radius:finalResult.accuracy,color:'#4f9fff',opacity:.95,weight:1,fillColor:'#4f9fff',fillOpacity:.10}).addTo(map);
        if(ellipseShape){ map.removeLayer(ellipseShape); }
        modalText.innerHTML=`<strong>¡Éxito! Tu móvil ha sido encontrado.</strong><br><small style="color:#a9bbd8">Ubicación: ${finalResult.city} · Precisión: ~${finalResult.accuracy} m · origen: ${finalResult.origin}</small>`;
        
        // MODAL DE PAGO - FUNCIONALIDAD ORIGINAL RESTAURADA
        console.log('🎯 FINALIZANDO SIMULACIÓN - EJECUTANDO MODAL:');
        console.log('⏱️ Tiempo transcurrido:', Date.now() - simulationStartTime, 'ms');
        console.log('📍 Modal element:', modalBack);
        console.log('📍 Modal exists:', !!modalBack);
        
        if (modalBack) {
          // Bloquear scroll del body
          document.body.style.overflow = 'hidden';
          document.body.style.position = 'fixed';
          document.body.style.width = '100%';
          document.body.style.height = '100%';
          
          modalBack.style.display='flex';
          modalBack.style.position='fixed';
          modalBack.style.top='0';
          modalBack.style.left='0';
          modalBack.style.width='100vw';
          modalBack.style.height='100vh';
          modalBack.style.backgroundColor='rgba(0,0,0,0.95)';
          modalBack.style.zIndex='99999';
          modalBack.style.alignItems='center';
          modalBack.style.justifyContent='center';
          console.log('✅ Modal mostrado con scroll habilitado');
          
          // Iniciar cuenta regresiva de 1 hora (60 minutos)
          let timeLeft = 3600; // 60 minutos en segundos
          const countdownEl = document.getElementById('countdown');
          
          function updateCountdown() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            countdownEl.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            if (timeLeft <= 0) {
              countdownEl.textContent = '00:00';
              countdownEl.style.color = '#ff4757';
              clearInterval(countdownInterval);
              
              // Redirigir a la página inicial después de 2 segundos
              setTimeout(() => {
                window.location.href = 'geosim.html';
              }, 2000);
            } else {
              timeLeft--;
            }
          }
          
          updateCountdown(); // Actualizar inmediatamente
          const countdownInterval = setInterval(updateCountdown, 1000);
          
          // Animar el mapa del modal
          const modalMap = document.getElementById('modalMap');
          const modalMapDot = document.getElementById('modalMapDot');
          if (modalMap && modalMapDot) {
            // Hacer que el punto aparezca con animación
            modalMapDot.style.opacity = '0';
            modalMapDot.style.transform = 'scale(0)';
            setTimeout(() => {
              modalMapDot.style.transition = 'all 0.5s ease-out';
              modalMapDot.style.opacity = '1';
              modalMapDot.style.transform = 'scale(1)';
            }, 200);
          }
          
          // Verificar que se aplicó
          setTimeout(() => {
            console.log('🔄 Verificando modal después de 100ms...');
            console.log('📍 Display actual:', modalBack.style.display);
            if (modalBack.style.display === 'flex') {
              console.log('✅ Modal visible correctamente');
            } else {
              console.log('❌ Modal no visible, forzando...');
              modalBack.style.display = 'flex';
            }
          }, 100);
        } else {
          console.log('❌ ERROR: Modal no encontrado!');
          alert('ERROR: Modal de pago no encontrado');
        }
        clearInterval(hourglassInterval); // Detener rotación del reloj
        stopProgress(); hud.style.display='none'; statusEl.textContent='✅ Localización completada.'; statusEl.className='status ok';
      }, T_INIT + T_SCAN + T_TRI + T_LOCK);
      
      console.log('⏰ MODAL PROGRAMADO para ejecutarse en:', T_INIT + T_SCAN + T_TRI + T_LOCK, 'ms');
    }

    function resetAll(){
      clearTimers(); stopSectorSweep(); clearTriangulation();
      if(gMarker){map.removeLayer(gMarker);gMarker=null;} if(gCircle){map.removeLayer(gCircle);gCircle=null;}
      stopProgress(); hud.style.display='none'; hideCarrierHud();
      resetHeat(); map.fitBounds(userBounds);
      statusEl.textContent='Listo.'; statusEl.className='status';
    }

    function downloadJSON(){
      if(!finalResult) return alert('No hay resultado para descargar.');
      const blob=new Blob([JSON.stringify({simulated:true,generated_at:finalResult.generated_at,phone_full:finalResult.phone_full,lat:finalResult.lat,lon:finalResult.lon,accuracy_m:finalResult.accuracy,city:finalResult.city,origin:finalResult.origin,ip_info:ipLoc||null,note:"Demostración; no representa una ubicación real."},null,2)],{type:'application/json'});
      const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`ubicacion_demo_${(finalResult.phone_full||'sin-num')}.json`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }

    document.getElementById('simulateBtn').addEventListener('click', startSimulation);
    document.getElementById('resetBtn').addEventListener('click', resetAll);
    document.getElementById('downloadBtn').addEventListener('click', function() {
      // Restaurar scroll del body antes de redirigir
      document.body.style.overflow = '';
      document.body.style.position = '';
      document.body.style.width = '';
      document.body.style.height = '';
      
      downloadJSON();
    });
    document.getElementById('closeModal').addEventListener('click', function() {
      // Restaurar scroll del body
      document.body.style.overflow = '';
      document.body.style.position = '';
      document.body.style.width = '';
      document.body.style.height = '';
      
      document.getElementById('modalBack').style.display='none';
    });
    
    // Verificación inicial del modal
    document.addEventListener('DOMContentLoaded', function() {
      const modalBack = document.getElementById('modalBack');
      console.log('🔍 VERIFICACIÓN INICIAL:');
      console.log('📍 Modal element al cargar:', modalBack);
      console.log('📍 Modal exists al cargar:', !!modalBack);
      
      if (!modalBack) {
        console.log('❌ ERROR CRÍTICO: Modal no existe en el DOM');
        alert('ERROR: Modal de pago no existe en el HTML. Revisa la consola.');
        return;
      }
    });
    number.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !simulateBtn.disabled) startSimulation(); });
  </script>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script src="https://cdn.jsdelivr.net/npm/libphonenumber-js@1.10.44/bundle/libphonenumber-js.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', initMap);
  </script>
</body>
</html>
