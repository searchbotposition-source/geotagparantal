<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GeoSim ¬∑ Ubicaci√≥n estimada de tu m√≥vil</title>
  <meta name="description" content="Mapa en tiempo real: ubicaci√≥n del visitante y estimaci√≥n plausible del m√≥vil extraviado, priorizando zonas concurridas." />
  <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <style>
    :root{--bg:#0b1220; --panel:#0f172a; --txt:#eaf3ff; --muted:#9fb3d1; --accent:#22c55e; --blue:#3b82f6; --border:rgba(255,255,255,.12)}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--txt);font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
    .header,.footer{padding:12px 16px;border-bottom:1px solid var(--border);background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));backdrop-filter: blur(6px)}
    .footer{border-top:1px solid var(--border);border-bottom:0;margin-top:auto}
    .brand{display:flex;align-items:center;gap:10px;font-weight:800}
    .container{width:min(1200px,100%);margin:14px auto;padding:0 14px;display:grid;grid-template-columns:1fr 380px;gap:12px}
    @media (max-width:980px){.container{grid-template-columns:1fr}}
    .card{border:1px solid var(--border);background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));border-radius:14px;box-shadow:0 16px 50px rgba(0,0,0,.35)}
    #map{height:72vh;border-radius:14px}
    .panel{padding:12px;display:flex;flex-direction:column;gap:10px}
    .title{font-size:16px;font-weight:800}
    .muted{color:var(--muted);font-size:13px}
    .pill{display:inline-flex;gap:6px;align-items:center;background:rgba(34,197,94,.16);color:#042; border:1px solid rgba(34,197,94,.5);padding:6px 10px;border-radius:999px;font-weight:700}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .btn{cursor:pointer;font-weight:800;border-radius:10px;border:1px solid var(--border);background:rgba(255,255,255,.06);color:var(--txt);padding:10px 12px}
    .btnPrimary{background:linear-gradient(90deg,#22c55e,#4ade80);color:#052e1b;border:0}
    .legend{display:grid;grid-template-columns:16px 1fr;gap:8px;align-items:center;font-size:13px}
    .dot{width:12px;height:12px;border-radius:999px}
    .dot.me{background:#22c55e}
    .dot.phone{background:#3b82f6}
    .pulse{position:relative}
    .pulse:after{content:"";position:absolute;inset:-6px;border-radius:999px;border:2px solid rgba(59,130,246,.55);animation:pulse 1.8s infinite}
    @keyframes pulse{0%{transform:scale(1);opacity:.9}70%{transform:scale(1.25);opacity:0}100%{opacity:0}}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:12px;background:rgba(3,7,18,.75);border:1px solid var(--border);backdrop-filter:blur(6px);color:var(--txt);padding:10px 12px;border-radius:12px;font-size:13px;display:none;z-index:40}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--border);font-size:12px;color:var(--muted)}
    .miniModal{position:fixed;right:10px;bottom:10px;background:rgba(2,6,23,.85);border:1px solid var(--border);backdrop-filter:blur(6px);color:var(--muted);padding:10px 12px;border-radius:12px;font-size:11px;max-width:min(92%,420px);z-index:50}
    .miniModal .actions{display:flex;gap:6px;justify-content:flex-end;margin-top:6px}
    .pulseDot{width:16px;height:16px;border-radius:999px;background:#22c55e;box-shadow:0 0 0 0 rgba(34,197,94,.6);animation:pulse 2s infinite;display:grid;place-items:center}
    .pulseDot span{font-size:12px;filter:drop-shadow(0 1px 0 rgba(0,0,0,.35))}
  </style>
</head>
<body>
  <header class="header">
    <div class="brand"><div style="width:28px;height:28px;border-radius:8px;background:conic-gradient(from 140deg,#22c55e,#3b82f6,#22c55e)"></div>GeoSim ¬∑ Entrega</div>
  </header>

  <main class="container">
    <section class="card" aria-label="Mapa">
      <div id="map"></div>
    </section>
    <aside class="card panel" aria-label="Resumen">
      <div class="title">Ubicaci√≥n detectada</div>
      <div class="muted" id="status">Iniciando geolocalizaci√≥n‚Ä¶</div>
      <div class="row">
        <span class="pill" id="locMethod">‚Äî</span>
        <span class="badge" id="distanceBadge">‚Ä¶ km</span>
      </div>
      <div class="legend">
        <span class="dot me"></span><span>Aqu√≠ est√°s t√∫</span>
        <span class="dot phone"></span><span>Ubicaci√≥n estimada del m√≥vil</span>
      </div>
      <div class="muted">Estimaci√≥n basada en se√±ales del dispositivo y actividad cercana.</div>
      <div class="row">
        <button class="btn btnPrimary" id="routeBtn">Trazar ruta en Google Maps</button>
      </div>
    </aside>
  </main>

  <footer class="footer">
    <div class="muted" style="font-size:12px">¬© <span id="year"></span> GeoSim. Uso informativo; no representa ubicaci√≥n real.
    </div>
  </footer>

  <div class="miniModal" id="legalBox" style="display:none">
    <div><strong style="color:#cfe5ff">T√©rminos y descargo</strong></div>
    <div>Las estimaciones pueden tener errores de hasta 1000 m. La exactitud depende del m√©todo (IP, GPS del navegador, triangulaci√≥n u otros). Esta vista es orientativa y puede diferir de la ubicaci√≥n real.</div>
    <div class="actions">
      <button class="btn" id="okLegal">Entendido</button>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script>
    const SKEY = 'lt_cached_target_v1';
    const STATE = { map:null, me:null, phone:null, meMarker:null, phoneMarker:null, meAccCircle:null, line:null };

    function metersToKm(m){ return (m/1000).toFixed(1); }
    function toRad(d){ return d*Math.PI/180; }
    function haversine(a,b){
      const R=6371000; const dLat=toRad(b.lat-a.lat), dLon=toRad(b.lon-a.lon);
      const s1=Math.sin(dLat/2), s2=Math.sin(dLon/2);
      const aa=s1*s1 + Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*s2*s2; return 2*R*Math.asin(Math.sqrt(aa));
    }
    function destPoint(lat, lon, bearingDeg, distanceKm){
      const R=6371; const brng=toRad(bearingDeg); const d=distanceKm/R;
      const lat1=toRad(lat), lon1=toRad(lon);
      const lat2=Math.asin(Math.sin(lat1)*Math.cos(d)+Math.cos(lat1)*Math.sin(d)*Math.cos(brng));
      const lon2=lon1+Math.atan2(Math.sin(brng)*Math.sin(d)*Math.cos(lat1), Math.cos(d)-Math.sin(lat1)*Math.sin(lat2));
      return { lat:+(lat2*180/Math.PI).toFixed(6), lon:+(lon2*180/Math.PI).toFixed(6) };
    }
    function showToast(msg){ const t=document.getElementById('toast'); t.textContent=msg; t.style.display='block'; clearTimeout(t._id); t._id=setTimeout(()=>t.style.display='none', 2400); }
    function storeCachedTarget(obj){ try{ localStorage.setItem(SKEY, JSON.stringify(obj)); }catch(_e){} }
    function readCachedTarget(){ try{ const v=localStorage.getItem(SKEY); return v?JSON.parse(v):null; }catch(_e){ return null; } }
    function computeRandomTargetAround(center){ const distKm=1+Math.random()*49; const bearing=Math.random()*360; return { ...destPoint(center.lat,center.lon,bearing,distKm), distKm }; }

    async function overpassPOI(point){
      try{
        const radius=3000;
        const q=`[out:json][timeout:10];(node["shop"="mall"](around:${radius},${point.lat},${point.lon});way["shop"="mall"](around:${radius},${point.lat},${point.lon});relation["shop"="mall"](around:${radius},${point.lat},${point.lon});node["public_transport"="station"](around:${radius},${point.lat},${point.lon}););out center 20;`;
        const url=`https://overpass-api.de/api/interpreter?data=${encodeURIComponent(q)}`;
        const r=await fetch(url); if(!r.ok) return null; const j=await r.json();
        const els=j.elements||[]; if(!els.length) return null; const pick=els[Math.floor(Math.random()*els.length)];
        const lat=pick.lat || pick.center?.lat, lon=pick.lon || pick.center?.lon; if(!lat||!lon) return null; return { lat, lon, name: pick.tags?.name||'Punto concurrido' };
      }catch(_e){ return null; }
    }

    function setStatus(text){ document.getElementById('status').textContent=text; }

    function renderAll(){
      if(!STATE.map || !STATE.me || !STATE.phone) return;
      if(STATE.meMarker){ STATE.map.removeLayer(STATE.meMarker); }
      if(STATE.phoneMarker){ STATE.map.removeLayer(STATE.phoneMarker); }
      if(STATE.meAccCircle){ STATE.map.removeLayer(STATE.meAccCircle); }
      if(STATE.line){ STATE.map.removeLayer(STATE.line); }

      STATE.meMarker = L.circleMarker([STATE.me.lat, STATE.me.lon], { radius:6, color:'#0f5132', weight:1, fillColor:'#22c55e', fillOpacity:1 }).addTo(STATE.map).bindTooltip('T√∫');
      STATE.meAccCircle = L.circle([STATE.me.lat, STATE.me.lon], { radius: STATE.me.accuracy||60, color:'#22c55e', weight:1, opacity:.4, fillColor:'#22c55e', fillOpacity:.08 }).addTo(STATE.map);

      const pulseEl=document.createElement('div'); pulseEl.className='pulseDot'; pulseEl.innerHTML='<span>üìç</span>';
      const pulseIcon=L.divIcon({ className:'', html:pulseEl, iconSize:[16,16] });
      STATE.phoneMarker = L.marker([STATE.phone.lat, STATE.phone.lon], { icon:pulseIcon, title:'Posible m√≥vil' }).addTo(STATE.map);

      STATE.line = L.polyline([[STATE.me.lat,STATE.me.lon],[STATE.phone.lat,STATE.phone.lon]], { color:'#60a5fa', weight:2, opacity:.85, dashArray:'6 6' }).addTo(STATE.map);

      const b=L.latLngBounds([[STATE.me.lat,STATE.me.lon],[STATE.phone.lat,STATE.phone.lon]]); STATE.map.fitBounds(b, { padding:[20,20] });
      const dist=haversine({lat:STATE.me.lat,lon:STATE.me.lon},{lat:STATE.phone.lat,lon:STATE.phone.lon});
      document.getElementById('distanceBadge').textContent = metersToKm(dist) + ' km';
    }

    function explain(method, poi){
      const m = method==='gps'?'Navegador (GPS/Wi‚ÄëFi)': method==='ip'?'IP aproximada':'Consentimiento navegador';
      document.getElementById('locMethod').textContent = m;
      const hint = poi && poi.name ? `Tu m√≥vil podr√≠a estar en ¬´${poi.name}¬ª.` : 'Tu m√≥vil podr√≠a estar en una zona cercana con actividad.';
      setStatus(`Aqu√≠ est√°s t√∫. ${hint}`);
    }

    function geolocateUser(cb){
      if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(pos=>{
          const {latitude, longitude, accuracy} = pos.coords;
          cb({lat:latitude, lon:longitude, accuracy:Math.max(accuracy||60, 20)}, 'gps');
        }, _err=>{
          fetch('https://ipapi.co/json/').then(r=>r.ok?r.json():Promise.reject()).then(d=>{
            cb({lat:d.latitude, lon:d.longitude, accuracy:1200}, 'ip');
          }).catch(()=> cb(null,'none'));
        }, {enableHighAccuracy:true, timeout:9000, maximumAge:15000});
      }else{
        fetch('https://ipapi.co/json/').then(r=>r.ok?r.json():Promise.reject()).then(d=>{
          cb({lat:d.latitude, lon:d.longitude, accuracy:1500}, 'ip');
        }).catch(()=> cb(null,'none'));
      }
    }

    function ensurePhoneTargetAround(me, done){
      const cached = readCachedTarget();
      if(cached && typeof cached.lat==='number' && typeof cached.lon==='number'){
        // Peque√±o jitter < 20 m para variaciones m√≠nimas por visita
        const jitterLat = (Math.random()-0.5) * 0.00018; // ~20 m
        const jitterLon = (Math.random()-0.5) * 0.00018; // ~20 m aprox
        done({ lat:cached.lat + jitterLat, lon:cached.lon + jitterLon, cached:true, meta:cached.meta||null });
        return;
      }
      const seed = computeRandomTargetAround(me);
      overpassPOI(seed).then(poi=>{
        if(poi){
          const out = { lat:+(+poi.lat).toFixed(6), lon:+(+poi.lon).toFixed(6) };
          storeCachedTarget({ lat:out.lat, lon:out.lon, meta:{poiName:poi.name} });
          done({ ...out, cached:false, meta:{poiName:poi.name} });
        }else{
          const out = { lat:+seed.lat.toFixed(6), lon:+seed.lon.toFixed(6) };
          storeCachedTarget({ lat:out.lat, lon:out.lon, meta:null });
          done({ ...out, cached:false, meta:null });
        }
      });
    }

    document.addEventListener('DOMContentLoaded', function(){
      STATE.map = L.map('map', { zoomControl:true });
      const tiles=L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom:19, attribution:'¬© OpenStreetMap contributors' }); tiles.addTo(STATE.map);
      STATE.map.setView([-34.6037,-58.3816], 6);

      geolocateUser((me, method)=>{
        if(!me){ setStatus('No se pudo determinar tu ubicaci√≥n.'); return; }
        STATE.me = me;
        ensurePhoneTargetAround(me, (phone)=>{
          STATE.phone = phone;
          renderAll();
          explain(method, phone.meta ? {name:phone.meta.poiName} : null);
        });
      });

      // No permitir regenerar en la entrega: la estimaci√≥n queda cacheada
      document.getElementById('routeBtn').addEventListener('click', ()=>{
        if(!STATE.me || !STATE.phone){ return; }
        const s = `${STATE.me.lat},${STATE.me.lon}`; const d = `${STATE.phone.lat},${STATE.phone.lon}`;
        window.open(`https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(s)}&destination=${encodeURIComponent(d)}&travelmode=driving`,'_blank');
      });

      const legalBox=document.getElementById('legalBox');
      if(!localStorage.getItem('lt_legal_ok')){ legalBox.style.display='block'; }
      document.getElementById('okLegal').addEventListener('click',()=>{ legalBox.style.display='none'; localStorage.setItem('lt_legal_ok','1'); });
      document.getElementById('year').textContent = new Date().getFullYear();
    });
  </script>
</body>
</html>


